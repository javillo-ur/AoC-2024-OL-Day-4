Console.WriteLine(new List<List<string>>(){File.ReadAllLines("input.txt").ToList()}.Select(mat => mat.SelectMany((row, irow) => row.Select((col, icol) => (irow, icol, col))).ToDictionary(x => (x.irow, x.icol), x => x.col)).Select(mat => (mat, mat.Max(x => x.Key.irow), mat.Max(x => x.Key.icol))).Select(mat => Enumerable.Range(0, mat.Item2+1).Sum(irow => Enumerable.Range(0, mat.Item3+1).Sum(icol => new List<(int,int)>(){(1,0), (1,1), (0,1), (-1,1), (-1,0), (-1,-1), (0,-1), (1,-1)}.Sum(dir => Enumerable.Range(0, 4).Select(scalar => (irow + dir.Item1 * scalar, icol + dir.Item2 * scalar, scalar)).All(pos => mat.mat.ContainsKey((pos.Item1, pos.Item2)) && mat.mat[(pos.Item1, pos.Item2)] == (pos.scalar == 0 ? 'X' : pos.scalar == 1 ? 'M' : pos.scalar == 2 ? 'A' : 'S')) ? 1 : 0)))).Sum());