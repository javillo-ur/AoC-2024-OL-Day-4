Console.WriteLine(new List<List<string>>(){File.ReadAllLines("input.txt").ToList()}.Select(mat => mat.SelectMany((row, irow) => row.Select((col, icol) => (irow, icol, col))).ToDictionary(x => (x.irow, x.icol), x => x.col)).Select(mat => (mat, mat.Max(x => x.Key.irow), mat.Max(x => x.Key.icol))).Select(mat => Enumerable.Range(0, mat.Item2+1).Sum(irow => Enumerable.Range(0, mat.Item3+1).Sum(icol => (mat.mat.ContainsKey((irow-1, icol-1)) && mat.mat.ContainsKey((irow+1, icol+1)) && (mat.mat[(irow, icol)] == 'A') && ((mat.mat[(irow-1, icol-1)] == 'M' && mat.mat[(irow+1, icol+1)] == 'S') || (mat.mat[(irow-1, icol-1)] == 'S' && mat.mat[(irow+1, icol+1)] == 'M')) && ((mat.mat[(irow+1, icol-1)] == 'S' && mat.mat[(irow-1, icol+1)] == 'M') || (mat.mat[(irow+1, icol-1)] == 'M' && mat.mat[(irow-1, icol+1)] == 'S'))) ? 1 : 0))).Sum());